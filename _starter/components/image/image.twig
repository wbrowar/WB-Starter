{# @var craft \craft\web\twig\variables\CraftVariable #}

{% extends 'partials/_component.twig' %}

{# Component element overrides #}
{% set element = 'figure' %}

{# Variables #}
{% set alt = alt ?? null %}
{% set caption = caption ?? null %}
{% set intrinsicsize = intrinsicsize ?? true %}
{% set image = image ?? null %}
{% set loading = loading ?? 'lazy' %}
{% set placeholder = placeholder ?? 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==' %}
{% set sizes = sizes ?? '100vw' %}
{% set sources = sources ?? [] %}
{% set transformer = transformer ?? 'imager' %}

{% block content -%}
    {% import _self as self %}

    <picture>
        {% for source in sources %}
            {% set options = {
                alt: source.alt ?? alt,
                image: source.image ?? image,
                loading: source.loading ?? loading,
                media: source.media ?? null,
                placeholder: source.placeholder ?? placeholder,
                sizes: source.sizes ?? sizes,
                transformer: source.transformer ?? transformer,
                transforms: source.transforms ?? [],
            } %}

            {% if options.transformer == 'imager' %}
                {% set globals = source.globals ?? {} %}
                {% set globals = globals|merge({ position: imager.globals.position ?? image.getFocalPoint() ?? '50% 50%' }) %}
                {% set transformedImages = craft.imager.transformImage(options.image, options.transforms, globals) %}

                {% set options = options|merge({
                    srcset: craft.imager.srcset(transformedImages),
                    intrinsicsize: intrinsicsize ? transformedImages[0].width ~ 'x' ~ transformedImages[0].height : null,
                    width: intrinsicsize ? transformedImages[0].width : null,
                }) %}

                {% if craft.imager.serverSupportsWebp() %}
                    {% set webpGlobals = globals|merge({ format: 'webp' }) %}
                    {% set webpTransformedImages = craft.imager.transformImage(options.image, options.transforms, webpGlobals) %}
                    {% set webpOptions = options|merge({
                        type: 'image/webp',
                        srcset: craft.imager.srcset(webpTransformedImages),
                    }) %}

                    {% if webpOptions.srcset ?? false %}
                        {{ self.renderSource('source', webpOptions) }}
                    {% endif %}
                {% endif %}

                {% if loop.last %}
                    {{ self.renderSource('img', options) }}
                {% else %}
                    {{ self.renderSource('source', options) }}
                {% endif %}
            {% elseif options.transformer == 'imageoptimize' %}
                {# Add ImageOptimize version here #}
            {% else %}
                {% if options.transforms|length %}
                    {% set options = options|merge({
                        srcset: self.getSrcSetFromObject({ image: options.image, transforms: options.transforms }),
                    }) %}

                    {% if loop.last %}
                        {{ self.renderSource('img', options) }}
                    {% else %}
                        {{ self.renderSource('source', options) }}
                    {% endif %}
                {% else %}
                    {% set options = options|merge({
                        src: options.image,
                    }) %}

                    {{ self.renderSource('img', options) }}
                {% endif %}
            {% endif %}
        {% endfor %}
    </picture>
    {% if caption ?? false -%}
        <figcaption class="{{ rootClass }}__caption">{{ caption }}</figcaption>
    {%- endif %}
{%- endblock %}

{% macro renderSource(element, options) %}{% spaceless %}
    {% set attrs = {
        loading: options.loading,
        intrinsicsize: options.intrinsicsize ?? null,
        sizes: options.sizes,
        width: options.width ?? null,
        height: options.height ?? null,
    } %}

    {% if element == 'img' %}
        {% set attrs = attrs|merge({
            alt: options.alt ?? null,
            src: options.src ?? options.placeholder ?? null,
        }) %}
    {% elseif element == 'source' %}
        {% set attrs = attrs|merge({
            media: options.media ?? null,
            type: options.type ?? null,
        }) %}
    {% endif %}

    {% if options.loading == 'lazy' %}
        {% set attrs = attrs|merge({
            'data-lazy-load': true,
            'data-src': options.src ?? null,
            'data-srcset': options.srcset ?? null,
        }) %}
    {% else %}
        {% set attrs = attrs|merge({
            src: options.src ?? null,
            srcset: options.srcset ?? null,
        }) %}
    {% endif %}

    <{{ element }}{{ attr(attrs) }} />
{% endspaceless %}{% endmacro %}

{% macro getSrcSetFromObject(options) %}{% spaceless %}
    {% set image = options.image ?? null %}
    {% set transforms = options.transforms ?? {} %}
    {% set suffix = options.suffix ?? null %}

    {% if (image ?? false) and (transforms|length) %}
        {% for transform in transforms %}{% if not loop.first %}, {% endif %}{{ image.getUrl(transform) }}{{ suffix }}{{ (transform.width ?? false) ? ' ' ~ transform.width ~ 'w' : '' }}{% endfor %}
    {% endif %}
{% endspaceless %}{% endmacro %}